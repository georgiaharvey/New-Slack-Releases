<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Releases</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f8f9fb;
            min-height: 100vh;
            color: #1e1e1e;
        }
        
        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #1e1e1e;
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: #6b7280;
            font-size: 0.95em;
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
            padding: 10px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95em;
        }
        
        .button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95em;
            transition: all 0.2s;
        }
        
        .refresh-btn {
            background: #5b6ef8;
            color: white;
        }
        
        .refresh-btn:hover {
            background: #4c5ed9;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            gap: 20px;
        }
        
        .main-content {
            flex: 1;
        }
        
        .sidebar {
            width: 280px;
            position: sticky;
            top: 160px;
            height: fit-content;
        }
        
        .stats-row {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            flex: 1;
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .date-filter-card {
            flex: 2;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: 600;
            color: #1e1e1e;
        }
        
        .date-range {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .date-input {
            border: 1px solid #e5e7eb;
            background: white;
            font-size: 0.85em;
            color: #1e1e1e;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 4px;
            flex: 1;
        }
        
        .date-separator {
            color: #6b7280;
            font-size: 0.9em;
        }
        
        .stages-section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            margin-bottom: 16px;
        }
        
        .stages-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #1e1e1e;
        }
        
        .stages-hint {
            font-size: 0.85em;
            color: #6b7280;
            margin-bottom: 16px;
        }
        
        .stage-tag {
            padding: 8px 16px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: grab;
            text-align: center;
            font-weight: 500;
            font-size: 0.9em;
            transition: transform 0.2s;
        }
        
        .stage-tag:active {
            cursor: grabbing;
            transform: scale(1.05);
        }
        
        .stage-internal {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .stage-ga {
            background: #d1fae5;
            color: #065f46;
        }
        
        .stage-exclusion {
            background: #fef3c7;
            color: #92400e;
        }
        
        /* Gemini Chat Section */
        .gemini-section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .gemini-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .gemini-title {
            font-weight: 600;
            color: #1e1e1e;
            font-size: 0.95em;
        }
        
        .gemini-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
            padding: 8px;
            background: #f8f9fb;
            border-radius: 6px;
        }
        
        .message {
            margin-bottom: 12px;
            display: flex;
            gap: 8px;
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message-bubble {
            max-width: 85%;
            padding: 8px 12px;
            border-radius: 8px;
            background: white;
            font-size: 0.9em;
            border: 1px solid #e5e7eb;
        }
        
        .message.user .message-bubble {
            background: #8b5cf6;
            color: white;
            border: none;
        }
        
        .gemini-input-area {
            display: flex;
            gap: 8px;
        }
        
        .gemini-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .gemini-send {
            padding: 8px 16px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
        }
        
        .gemini-send:hover {
            background: #7c3aed;
        }
        
        .release-card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
            transition: box-shadow 0.2s ease;
            position: relative;
        }
        
        .release-card.drag-over {
            border-color: #5b6ef8;
            box-shadow: 0 4px 12px rgba(91, 110, 248, 0.2);
        }
        
        .release-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .card-stage {
            position: absolute;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: move;
            z-index: 10;
        }
        
        .card-stage.dragging {
            opacity: 0.5;
            z-index: 20;
        }
        
        .stage-remove {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            margin-left: 4px;
        }
        
        .stage-remove:hover {
            opacity: 1;
        }
        
        .release-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .author-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #5b6ef8;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .author-details {
            display: flex;
            flex-direction: column;
        }
        
        .author-name {
            font-weight: 600;
            color: #1e1e1e;
            font-size: 0.95em;
        }
        
        .timestamp {
            color: #9ca3af;
            font-size: 0.85em;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .slack-link, .image-link {
            text-decoration: none;
            color: #5b6ef8;
            font-size: 0.9em;
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            transition: all 0.2s ease;
            background: white;
        }
        
        .slack-link:hover, .image-link:hover {
            border-color: #5b6ef8;
            background: #f0f4ff;
        }
        
        .image-link {
            padding: 6px 10px;
            font-size: 1.1em;
        }
        
        .release-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #1e1e1e;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        
        .release-content {
            color: #4b5563;
            line-height: 1.6;
            font-size: 0.95em;
        }
        
        .release-content strong {
            color: #1e1e1e;
            font-weight: 600;
        }
        
        .content-section {
            margin-bottom: 12px;
        }
        
        .content-section-header {
            font-weight: 600;
            color: #1e1e1e;
            margin-bottom: 6px;
        }
        
        .content-section ul {
            list-style: none;
            margin-left: 20px;
            margin-top: 4px;
        }
        
        .content-section li {
            position: relative;
            margin-bottom: 4px;
            padding-left: 20px;
        }
        
        .content-section li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #6b7280;
        }
        
        .loading {
            text-align: center;
            color: #9ca3af;
            font-size: 1.1em;
            padding: 60px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Product Releases</h1>
            <p class="subtitle">Track and analyze your team's release communications</p>
            <div class="controls">
                <input type="text" class="search-box" placeholder="Search releases, messages, or team members..." id="searchBox">
                <button class="button refresh-btn" onclick="refreshData()">🔄 Refresh Data</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="main-content">
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-label">Total Releases</div>
                    <div class="stat-value" id="totalReleases">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Contributors</div>
                    <div class="stat-value" id="activeContributors">0</div>
                </div>
                <div class="stat-card date-filter-card">
                    <div class="stat-label">Date Range Filter</div>
                    <div class="date-range">
                        <input type="date" class="date-input" id="startDate" onchange="filterByDateRange()">
                        <span class="date-separator">to</span>
                        <input type="date" class="date-input" id="endDate" onchange="filterByDateRange()">
                    </div>
                </div>
            </div>
            
            <div id="releases-container">
                <div class="loading">Loading releases...</div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="stages-section">
                <div class="stages-title">Stages</div>
                <div class="stages-hint">Drag a stage onto a release card</div>
                <div class="stage-tag stage-internal" draggable="true" data-stage="internal">Internal</div>
                <div class="stage-tag stage-ga" draggable="true" data-stage="ga">GA</div>
                <div class="stage-tag stage-exclusion" draggable="true" data-stage="exclusion">ENT Exclusion</div>
            </div>
            
            <div class="gemini-section">
                <div class="gemini-header">
                    <span class="gemini-title">✨ Ask Gemini</span>
                </div>
                <div class="gemini-messages" id="geminiMessages">
                    <div class="message">
                        <div class="message-bubble">
                            Hi! Ask me about your releases, trends, or patterns.
                        </div>
                    </div>
                </div>
                <div class="gemini-input-area">
                    <input type="text" class="gemini-input" id="geminiInput" placeholder="Ask about releases...">
                    <button class="gemini-send" onclick="sendToGemini()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Your Google Sheet configuration
        const SHEET_ID = '1I2ceg13BrlgQGYdVFI2Awxry1_PSoebxqKZEq6dyvIQ';
        const SHEET_NAME = 'October';
        
        let allReleases = [];
        let filteredReleases = [];
        
        // Function to format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            
            let date;
            
            if (typeof timestamp === 'string' && timestamp.startsWith('Date(')) {
                const matches = timestamp.match(/Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/);
                if (matches) {
                    date = new Date(
                        parseInt(matches[1]), 
                        parseInt(matches[2]), 
                        parseInt(matches[3]), 
                        parseInt(matches[4]), 
                        parseInt(matches[5]), 
                        parseInt(matches[6])
                    );
                }
            } else if (timestamp.includes('-') && timestamp.includes(':')) {
                date = new Date(timestamp.replace(' ', 'T') + 'Z');
            } else if (timestamp.length > 10) {
                date = new Date(parseFloat(timestamp) * 1000);
            } else {
                date = new Date(timestamp);
            }
            
            if (!date || isNaN(date.getTime())) {
                return '';
            }
            
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            
            const month = months[date.getMonth()];
            const day = date.getDate();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            return `${month} ${day}${getDaySuffix(day)} at ${hours}:${minutes} UTC`;
        }
        
        function getDaySuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }
        
        function getDateFromTimestamp(timestamp) {
            if (!timestamp) return null;
            
            let date;
            if (typeof timestamp === 'string' && timestamp.startsWith('Date(')) {
                const matches = timestamp.match(/Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/);
                if (matches) {
                    date = new Date(
                        parseInt(matches[1]), 
                        parseInt(matches[2]), 
                        parseInt(matches[3]), 
                        parseInt(matches[4]), 
                        parseInt(matches[5]), 
                        parseInt(matches[6])
                    );
                }
            } else if (timestamp.includes('-') && timestamp.includes(':')) {
                date = new Date(timestamp.replace(' ', 'T') + 'Z');
            } else {
                date = new Date(timestamp);
            }
            
            return date && !isNaN(date.getTime()) ? date : null;
        }
        
        // Enhanced content formatting
        function formatContent(text) {
            if (!text) return '';
            
            // Remove underscores
            text = text.replace(/_/g, '');
            
            // Handle asterisk formatting for bold (but not after colons)
            text = text.replace(/\*([^*:]+)\*/g, '<strong>$1</strong>');
            
            // Process section headers
            const sectionHeaders = [
                "What's New\\??", "Why it matters", "Why It Matters", "Problem", 
                "Solution", "What's in this release", "How to get started",
                "Admin Controls", "Member Experience", "Known Limitations",
                "Scope", "Key Results", "Known Limitations \\(Beta\\)"
            ];
            
            sectionHeaders.forEach(header => {
                const regex = new RegExp(`(${header})\\s*:?`, 'gi');
                text = text.replace(regex, (match) => {
                    const cleanHeader = match.replace(':', '').trim();
                    return `</div><div class="content-section"><div class="content-section-header">${cleanHeader}:</div>`;
                });
            });
            
            text = '<div class="content-section">' + text;
            
            // Process bullet points
            text = text.replace(/•\s*([^•\n]+)/g, '<ul><li>$1</li></ul>');
            
            // Process numbered lists
            text = text.replace(/(\d+)\.\s*([^0-9\n][^\n]*)/g, '<ul><li>$2</li></ul>');
            
            // Merge consecutive ul tags
            text = text.replace(/<\/ul>\s*<ul>/g, '');
            
            text = text + '</div>';
            
            // Clean up empty sections
            text = text.replace(/<div class="content-section"><\/div>/g, '');
            text = text.replace(/<div class="content-section">\s*<\/div>/g, '');
            
            return text;
        }
        
        // Date range filter
        function filterByDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate && !endDate) {
                filteredReleases = allReleases;
            } else {
                filteredReleases = allReleases.filter(release => {
                    const releaseDate = getDateFromTimestamp(release.timestamp);
                    if (!releaseDate) return false;
                    
                    const releaseDateOnly = new Date(releaseDate.getFullYear(), releaseDate.getMonth(), releaseDate.getDate());
                    
                    if (startDate && endDate) {
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        return releaseDateOnly >= start && releaseDateOnly <= end;
                    } else if (startDate) {
                        const start = new Date(startDate);
                        return releaseDateOnly >= start;
                    } else if (endDate) {
                        const end = new Date(endDate);
                        return releaseDateOnly <= end;
                    }
                    return true;
                });
            }
            
            renderReleases(filteredReleases);
        }
        
        // Search functionality
        function performSearch() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            if (!searchTerm) {
                filteredReleases = allReleases;
            } else {
                filteredReleases = allReleases.filter(release => {
                    return release.authorName.toLowerCase().includes(searchTerm) ||
                           release.content.toLowerCase().includes(searchTerm) ||
                           (release.title && release.title.toLowerCase().includes(searchTerm));
                });
            }
            
            renderReleases(filteredReleases);
        }
        
        // Update statistics
        function updateStats(releases) {
            document.getElementById('totalReleases').textContent = releases.length;
            const uniqueAuthors = [...new Set(releases.map(r => r.authorName))];
            document.getElementById('activeContributors').textContent = uniqueAuthors.length;
        }
        
        // Refresh data
        function refreshData() {
            const btn = document.querySelector('.refresh-btn');
            btn.textContent = '⏳ Refreshing...';
            loadReleases().then(() => {
                btn.textContent = '🔄 Refresh Data';
            });
        }
        
        // Gemini functions
        function sendToGemini() {
            const input = document.getElementById('geminiInput');
            const message = input.value.trim();
            if (!message) return;
            
            const messagesDiv = document.getElementById('geminiMessages');
            
            // Add user message
            messagesDiv.innerHTML += `
                <div class="message user">
                    <div class="message-bubble">${message}</div>
                </div>
            `;
            
            // Simulate AI response
            setTimeout(() => {
                messagesDiv.innerHTML += `
                    <div class="message">
                        <div class="message-bubble">
                            Based on your ${allReleases.length} releases, ${getMostActiveContributor()} is the most active contributor. 
                            The latest release was on ${formatTimestamp(allReleases[0]?.timestamp)}.
                        </div>
                    </div>
                `;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 1000);
            
            input.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function getMostActiveContributor() {
            const counts = {};
            allReleases.forEach(r => {
                counts[r.authorName] = (counts[r.authorName] || 0) + 1;
            });
            return Object.entries(counts).sort((a, b) => b[1] - a[1])[0]?.[0] || 'Unknown';
        }
        
        // Remove stage
        function removeStage(releaseId) {
            const release = allReleases.find(r => r.id === releaseId);
            if (release) {
                release.stage = null;
                renderReleases(filteredReleases.length > 0 ? filteredReleases : allReleases);
            }
        }
        
        // Drag stage on card
        function makeStagesDraggable() {
            document.querySelectorAll('.card-stage').forEach(stage => {
                let isDragging = false;
                let currentX;
                let currentY;
                let initialX;
                let initialY;
                let xOffset = 0;
                let yOffset = 0;
                
                stage.addEventListener('mousedown', dragStart);
                
                function dragStart(e) {
                    if (e.target.classList.contains('stage-remove')) return;
                    
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                    
                    if (e.target === stage || stage.contains(e.target)) {
                        isDragging = true;
                        stage.classList.add('dragging');
                    }
                }
                
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', dragEnd);
                
                function drag(e) {
                    if (!isDragging) return;
                    
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    
                    xOffset = currentX;
                    yOffset = currentY;
                    
                    stage.style.transform = `translate(${currentX}px, ${currentY}px)`;
                }
                
                function dragEnd() {
                    initialX = currentX;
                    initialY = currentY;
                    isDragging = false;
                    stage.classList.remove('dragging');
                }
            });
        }
        
        // Function to group messages
        function groupMessages(rows) {
            const mainMessages = [];
            
            rows.forEach(row => {
                if (row[7] === 'FALSE' || !row[7]) {
                    mainMessages.push({
                        id: row[0],
                        authorName: row[1],
                        timestamp: row[2],
                        title: row[3] || '',
                        content: row[4] || '',
                        slackLink: row[5] || '',
                        imageUrl: row[6] || '',
                        stage: null,
                        stagePosition: { x: 16, y: 16 }
                    });
                }
            });
            
            return mainMessages;
        }
        
        // Function to render releases
        function renderReleases(releases) {
            const container = document.getElementById('releases-container');
            
            if (!releases || releases.length === 0) {
                container.innerHTML = '<div class="loading">No releases found</div>';
                return;
            }
            
            // Sort by timestamp - most recent first
            releases.sort((a, b) => {
                const dateA = getDateFromTimestamp(a.timestamp);
                const dateB = getDateFromTimestamp(b.timestamp);
                if (!dateA || !dateB) return 0;
                return dateB.getTime() - dateA.getTime();
            });
            
            updateStats(releases);
            
            container.innerHTML = releases.map(release => {
                const initials = release.authorName.split(' ').map(n => n[0]).join('').toUpperCase();
                const stageHtml = release.stage ? 
                    `<div class="card-stage stage-${release.stage}" style="top: ${release.stagePosition.y}px; left: ${release.stagePosition.x}px;">
                        ${release.stage === 'exclusion' ? 'ENT Exclusion' : release.stage.toUpperCase()}
                        <span class="stage-remove" onclick="removeStage('${release.id}')">×</span>
                    </div>` : '';
                
                return `
                    <div class="release-card" data-id="${release.id}">
                        ${stageHtml}
                        <div class="release-header">
                            <div class="author-info">
                                <div class="author-avatar">${initials}</div>
                                <div class="author-details">
                                    <span class="author-name">${release.authorName}</span>
                                    <span class="timestamp">${formatTimestamp(release.timestamp)}</span>
                                </div>
                            </div>
                            <div class="action-buttons">
                                ${release.imageUrl ? 
                                    `<a href="${release.imageUrl}" target="_blank" class="image-link" title="View Image">📷</a>` 
                                    : ''}
                                ${release.slackLink ? `<a href="${release.slackLink}" target="_blank" class="slack-link">View in Slack →</a>` : ''}
                            </div>
                        </div>
                        
                        ${release.title ? `<div class="release-title">${formatContent(release.title)}</div>` : ''}
                        
                        <div class="release-content">${formatContent(release.content)}</div>
                    </div>
                `;
            }).join('');
            
            // Initialize drag and drop
            initializeDragAndDrop();
            makeStagesDraggable();
        }
        
        // Initialize drag and drop
        function initializeDragAndDrop() {
            const stageTags = document.querySelectorAll('.stage-tag');
            const releaseCards = document.querySelectorAll('.release-card');
            
            stageTags.forEach(tag => {
                tag.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'copy';
                    e.dataTransfer.setData('stage', tag.dataset.stage);
                });
            });
            
            releaseCards.forEach(card => {
                card.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    card.classList.add('drag-over');
                });
                
                card.addEventListener('dragleave', () => {
                    card.classList.remove('drag-over');
                });
                
                card.addEventListener('drop', (e) => {
                    e.preventDefault();
                    card.classList.remove('drag-over');
                    
                    const stage = e.dataTransfer.getData('stage');
                    const releaseId = card.dataset.id;
                    const rect = card.getBoundingClientRect();
                    
                    // Calculate drop position relative to card
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Update the release data
                    const release = allReleases.find(r => r.id === releaseId);
                    if (release) {
                        release.stage = stage;
                        release.stagePosition = { x: Math.max(16, x - 40), y: Math.max(16, y - 12) };
                    }
                    
                    // Re-render
                    renderReleases(filteredReleases.length > 0 ? filteredReleases : allReleases);
                });
            });
        }
        
        // Load releases from Google Sheets
        async function loadReleases() {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
                
                const response = await fetch(url);
                const text = await response.text();
                
                const jsonString = text.substring(47, text.length - 2);
                const data = JSON.parse(jsonString);
                
                const rows = data.table.rows.slice(1).map(row => 
                    row.c.map(cell => cell ? cell.v : '')
                );
                
                allReleases = groupMessages(rows);
                filteredReleases = allReleases;
                
                renderReleases(allReleases);
            } catch (error) {
                console.error('Error loading releases:', error);
                document.getElementById('releases-container').innerHTML = 
                    '<div class="loading">Error loading releases. Please check back later.</div>';
            }
        }
        
        // Event listeners
        document.getElementById('searchBox').addEventListener('input', performSearch);
        document.getElementById('geminiInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendToGemini();
        });
        
        // Load releases when page loads
        loadReleases();
        
        // Refresh every 2 minutes
        setInterval(loadReleases, 2 * 60 * 1000);
    </script>
</body>
</html>
