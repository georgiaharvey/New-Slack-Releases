<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Releases</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f8f9fb;
            min-height: 100vh;
            color: #1e1e1e;
        }
        
        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #1e1e1e;
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: #6b7280;
            font-size: 0.95em;
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
            padding: 10px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95em;
        }
        
        .button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95em;
            transition: all 0.2s;
        }
        
        .refresh-btn {
            background: #5b6ef8;
            color: white;
        }
        
        .refresh-btn:hover {
            background: #4c5ed9;
        }
        
        .gemini-btn {
            background: white;
            color: #8b5cf6;
            border: 1px solid #8b5cf6;
        }
        
        .gemini-btn:hover {
            background: #8b5cf6;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            gap: 20px;
        }
        
        .main-content {
            flex: 1;
        }
        
        .sidebar {
            width: 200px;
            position: sticky;
            top: 180px;
            height: fit-content;
        }
        
        .stats-row {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            flex: 1;
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.9em;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: 600;
            color: #1e1e1e;
        }
        
        .stages-section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e5e7eb;
        }
        
        .stages-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #1e1e1e;
        }
        
        .stages-hint {
            font-size: 0.85em;
            color: #6b7280;
            margin-bottom: 16px;
        }
        
        .stage-tag {
            padding: 8px 16px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: grab;
            text-align: center;
            font-weight: 500;
            font-size: 0.9em;
            transition: transform 0.2s;
        }
        
        .stage-tag:active {
            cursor: grabbing;
            transform: scale(1.05);
        }
        
        .stage-internal {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .stage-ga {
            background: #d1fae5;
            color: #065f46;
        }
        
        .stage-exclusion {
            background: #fef3c7;
            color: #92400e;
        }
        
        .release-card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
            transition: box-shadow 0.2s ease;
            position: relative;
        }
        
        .release-card.drag-over {
            border-color: #5b6ef8;
            box-shadow: 0 4px 12px rgba(91, 110, 248, 0.2);
        }
        
        .release-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .card-stage {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .release-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .author-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #5b6ef8;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .author-details {
            display: flex;
            flex-direction: column;
        }
        
        .author-name {
            font-weight: 600;
            color: #1e1e1e;
            font-size: 0.95em;
        }
        
        .timestamp {
            color: #9ca3af;
            font-size: 0.85em;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .slack-link, .image-link {
            text-decoration: none;
            color: #5b6ef8;
            font-size: 0.9em;
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            transition: all 0.2s ease;
            background: white;
        }
        
        .slack-link:hover, .image-link:hover {
            border-color: #5b6ef8;
            background: #f0f4ff;
        }
        
        .image-link {
            padding: 6px 10px;
            font-size: 1.1em;
        }
        
        .release-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #1e1e1e;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        
        .release-content {
            color: #4b5563;
            line-height: 1.6;
            font-size: 0.95em;
        }
        
        .release-content strong {
            color: #1e1e1e;
            font-weight: 600;
        }
        
        .content-section {
            margin-bottom: 16px;
        }
        
        .content-section-header {
            font-weight: 600;
            color: #1e1e1e;
            margin-bottom: 8px;
        }
        
        .content-section ul {
            list-style: none;
            margin-left: 20px;
        }
        
        .content-section li {
            position: relative;
            margin-bottom: 6px;
            padding-left: 20px;
        }
        
        .content-section li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #6b7280;
        }
        
        .loading {
            text-align: center;
            color: #9ca3af;
            font-size: 1.1em;
            padding: 60px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Product Releases</h1>
            <p class="subtitle">Track and analyze your team's release communications</p>
            <div class="controls">
                <input type="text" class="search-box" placeholder="Search releases, messages, or team members..." id="searchBox">
                <button class="button refresh-btn" onclick="refreshData()">🔄 Refresh Data</button>
                <button class="button gemini-btn" onclick="askGemini()">✨ Ask Gemini</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="main-content">
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-label">Total Releases</div>
                    <div class="stat-value" id="totalReleases">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Contributors</div>
                    <div class="stat-value" id="activeContributors">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Date Filter</div>
                    <div class="stat-value" id="dateFilter">All</div>
                </div>
            </div>
            
            <div id="releases-container">
                <div class="loading">Loading releases...</div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="stages-section">
                <div class="stages-title">Stages</div>
                <div class="stages-hint">Drag a stage onto a release card</div>
                <div class="stage-tag stage-internal" draggable="true" data-stage="internal">Internal</div>
                <div class="stage-tag stage-ga" draggable="true" data-stage="ga">GA</div>
                <div class="stage-tag stage-exclusion" draggable="true" data-stage="exclusion">ENT Exclusion</div>
            </div>
        </div>
    </div>

    <script>
        // Your Google Sheet configuration
        const SHEET_ID = '1I2ceg13BrlgQGYdVFI2Awxry1_PSoebxqKZEq6dyvIQ';
        const SHEET_NAME = 'October';
        
        let allReleases = [];
        let filteredReleases = [];
        
        // Function to format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            
            let date;
            
            if (typeof timestamp === 'string' && timestamp.startsWith('Date(')) {
                const matches = timestamp.match(/Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/);
                if (matches) {
                    date = new Date(
                        parseInt(matches[1]), 
                        parseInt(matches[2]), 
                        parseInt(matches[3]), 
                        parseInt(matches[4]), 
                        parseInt(matches[5]), 
                        parseInt(matches[6])
                    );
                }
            } else if (timestamp.includes('-') && timestamp.includes(':')) {
                date = new Date(timestamp.replace(' ', 'T') + 'Z');
            } else if (timestamp.length > 10) {
                date = new Date(parseFloat(timestamp) * 1000);
            } else {
                date = new Date(timestamp);
            }
            
            if (!date || isNaN(date.getTime())) {
                return '';
            }
            
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            
            const month = months[date.getMonth()];
            const day = date.getDate();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            return `${month} ${day}${getDaySuffix(day)} at ${hours}:${minutes} UTC`;
        }
        
        function getDaySuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }
        
        // Enhanced content formatting
        function formatContent(text) {
            if (!text) return '';
            
            // Remove underscores
            text = text.replace(/_/g, '');
            
            // Handle asterisk formatting for bold
            text = text.replace(/\*([^*]+)\*/g, '<strong>$1</strong>');
            
            // Headers that should trigger new sections
            const sectionHeaders = [
                "What's New\\??", "Why it matters?", "Why It Matters", "Problem:", "Problem", 
                "Solution:", "Solution", "What's in this release", "How to get started",
                "Admin Controls:", "Member Experience:", "Known Limitations",
                "Scope:", "Key Results"
            ];
            
            // Process section headers
            sectionHeaders.forEach(header => {
                const regex = new RegExp(`(${header})\\s*:?\\s*`, 'gi');
                text = text.replace(regex, (match) => {
                    return `</div><div class="content-section"><div class="content-section-header">${match.trim()}</div>`;
                });
            });
            
            // Wrap in initial section div
            text = '<div class="content-section">' + text;
            
            // Process bullet points
            text = text.replace(/•\s*([^•\n]+)/g, '<ul><li>$1</li></ul>');
            
            // Process numbered lists
            text = text.replace(/(\d+)\.\s*([^0-9\n][^\n]*)/g, '<ul><li>$2</li></ul>');
            
            // Merge consecutive ul tags
            text = text.replace(/<\/ul>\s*<ul>/g, '');
            
            // Close final section
            text = text + '</div>';
            
            // Clean up empty sections
            text = text.replace(/<div class="content-section"><\/div>/g, '');
            
            return text;
        }
        
        // Search functionality
        function performSearch() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            if (!searchTerm) {
                filteredReleases = allReleases;
            } else {
                filteredReleases = allReleases.filter(release => {
                    return release.authorName.toLowerCase().includes(searchTerm) ||
                           release.content.toLowerCase().includes(searchTerm) ||
                           (release.title && release.title.toLowerCase().includes(searchTerm));
                });
            }
            
            renderReleases(filteredReleases);
        }
        
        // Refresh data
        function refreshData() {
            const btn = document.querySelector('.refresh-btn');
            btn.textContent = '⏳ Refreshing...';
            loadReleases().then(() => {
                btn.textContent = '🔄 Refresh Data';
            });
        }
        
        // Ask Gemini
        function askGemini() {
            alert('Gemini integration would connect to Google\'s AI API to analyze your release notes and provide insights.');
        }
        
        // Function to group messages
        function groupMessages(rows) {
            const mainMessages = [];
            
            rows.forEach(row => {
                if (row[7] === 'FALSE' || !row[7]) {
                    mainMessages.push({
                        id: row[0],
                        authorName: row[1],
                        timestamp: row[2],
                        title: row[3] || '',
                        content: row[4] || '',
                        slackLink: row[5] || '',
                        imageUrl: row[6] || '',
                        stage: null
                    });
                }
            });
            
            return mainMessages;
        }
        
        // Function to render releases
        function renderReleases(releases) {
            const container = document.getElementById('releases-container');
            
            if (!releases || releases.length === 0) {
                container.innerHTML = '<div class="loading">No releases found</div>';
                return;
            }
            
            // Update stats
            document.getElementById('totalReleases').textContent = releases.length;
            const uniqueAuthors = [...new Set(releases.map(r => r.authorName))];
            document.getElementById('activeContributors').textContent = uniqueAuthors.length;
            
            container.innerHTML = releases.map(release => {
                const initials = release.authorName.split(' ').map(n => n[0]).join('').toUpperCase();
                const stageHtml = release.stage ? 
                    `<div class="card-stage stage-${release.stage}">${release.stage === 'exclusion' ? 'ENT Exclusion' : release.stage.toUpperCase()}</div>` : '';
                
                return `
                    <div class="release-card" data-id="${release.id}">
                        ${stageHtml}
                        <div class="release-header">
                            <div class="author-info">
                                <div class="author-avatar">${initials}</div>
                                <div class="author-details">
                                    <span class="author-name">${release.authorName}</span>
                                    <span class="timestamp">${formatTimestamp(release.timestamp)}</span>
                                </div>
                            </div>
                            <div class="action-buttons">
                                ${release.imageUrl ? 
                                    `<a href="${release.imageUrl}" target="_blank" class="image-link" title="View Image">📷</a>` 
                                    : ''}
                                ${release.slackLink ? `<a href="${release.slackLink}" target="_blank" class="slack-link">View in Slack →</a>` : ''}
                            </div>
                        </div>
                        
                        ${release.title ? `<div class="release-title">${formatContent(release.title)}</div>` : ''}
                        
                        <div class="release-content">${formatContent(release.content)}</div>
                    </div>
                `;
            }).join('');
            
            // Initialize drag and drop
            initializeDragAndDrop();
        }
        
        // Initialize drag and drop
        function initializeDragAndDrop() {
            const stageTags = document.querySelectorAll('.stage-tag');
            const releaseCards = document.querySelectorAll('.release-card');
            
            stageTags.forEach(tag => {
                tag.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'copy';
                    e.dataTransfer.setData('stage', tag.dataset.stage);
                });
            });
            
            releaseCards.forEach(card => {
                card.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    card.classList.add('drag-over');
                });
                
                card.addEventListener('dragleave', () => {
                    card.classList.remove('drag-over');
                });
                
                card.addEventListener('drop', (e) => {
                    e.preventDefault();
                    card.classList.remove('drag-over');
                    
                    const stage = e.dataTransfer.getData('stage');
                    const releaseId = card.dataset.id;
                    
                    // Update the release data
                    const release = allReleases.find(r => r.id === releaseId);
                    if (release) {
                        release.stage = stage;
                    }
                    
                    // Re-render with updated stage
                    renderReleases(filteredReleases.length > 0 ? filteredReleases : allReleases);
                });
                
                // Remove stage on click
                const stageElement = card.querySelector('.card-stage');
                if (stageElement) {
                    stageElement.addEventListener('click', () => {
                        const releaseId = card.dataset.id;
                        const release = allReleases.find(r => r.id === releaseId);
                        if (release) {
                            release.stage = null;
                        }
                        renderReleases(filteredReleases.length > 0 ? filteredReleases : allReleases);
                    });
                }
            });
        }
        
        // Load releases from Google Sheets
        async function loadReleases() {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
                
                const response = await fetch(url);
                const text = await response.text();
                
                const jsonString = text.substring(47, text.length - 2);
                const data = JSON.parse(jsonString);
                
                const rows = data.table.rows.slice(1).map(row => 
                    row.c.map(cell => cell ? cell.v : '')
                );
                
                allReleases = groupMessages(rows);
                filteredReleases = allReleases;
                
                // Sort by timestamp (newest first)
                allReleases.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                renderReleases(allReleases);
            } catch (error) {
                console.error('Error loading releases:', error);
                document.getElementById('releases-container').innerHTML = 
                    '<div class="loading">Error loading releases. Please check back later.</div>';
            }
        }
        
        // Event listeners
        document.getElementById('searchBox').addEventListener('input', performSearch);
        
        // Load releases when page loads
        loadReleases();
        
        // Refresh every 2 minutes
        setInterval(loadReleases, 2 * 60 * 1000);
    </script>
</body>
</html>
