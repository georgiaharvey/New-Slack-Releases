<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Release Notes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .release-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .release-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .release-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .author-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .author-name {
            font-weight: 600;
            color: #333;
        }
        
        .timestamp {
            color: #666;
            font-size: 0.9em;
        }
        
        .slack-link {
            text-decoration: none;
            color: #4A154B;
            font-size: 0.9em;
            padding: 5px 10px;
            border: 1px solid #4A154B;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .slack-link:hover {
            background: #4A154B;
            color: white;
        }
        
        .release-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .release-content {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .release-content em {
            color: #4A154B;
            font-style: italic;
        }
        
        .release-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .thread-toggle {
            background: #f8f9fa;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            color: #666;
            font-size: 0.9em;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .thread-toggle:hover {
            background: #e9ecef;
            color: #333;
        }
        
        .thread-toggle.active {
            background: #4A154B;
            color: white;
        }
        
        .thread-replies {
            margin-top: 15px;
            padding-left: 20px;
            border-left: 3px solid #e9ecef;
            display: none;
        }
        
        .thread-replies.show {
            display: block;
        }
        
        .reply-message {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .reply-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .release-card {
            animation: fadeIn 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“¦ Release Notes</h1>
        <div id="releases-container">
            <div class="loading">Loading releases...</div>
        </div>
    </div>

    <script>
        // Your Google Sheet configuration
        const SHEET_ID = '1I2ceg13BrlgQGYdVFI2Awxry1_PSoebxqKZEq6dyvIQ';
        const SHEET_NAME = 'October'; // Change this to match your sheet tab name
        
        // Function to format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            
            let date;
            
            // Handle Google Sheets date format: Date(2025,8,24,17,2,28)
            if (typeof timestamp === 'string' && timestamp.startsWith('Date(')) {
                const matches = timestamp.match(/Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/);
                if (matches) {
                    // Note: JavaScript months are 0-indexed, so we use the month value directly from Google Sheets
                    date = new Date(
                        parseInt(matches[1]), // year
                        parseInt(matches[2]), // month (0-indexed from Google Sheets)
                        parseInt(matches[3]), // day
                        parseInt(matches[4]), // hour
                        parseInt(matches[5]), // minute
                        parseInt(matches[6])  // second
                    );
                }
            } else if (timestamp.includes('-') && timestamp.includes(':')) {
                // Format like "2025-10-02 12:50:49"
                date = new Date(timestamp.replace(' ', 'T') + 'Z'); // Add Z for UTC
            } else if (timestamp.length > 10) {
                // Unix timestamp
                date = new Date(parseFloat(timestamp) * 1000);
            } else {
                date = new Date(timestamp);
            }
            
            // Check if date is valid
            if (!date || isNaN(date.getTime())) {
                return '';
            }
            
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            
            const month = months[date.getMonth()];
            const day = date.getDate();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            // Add ordinal suffix to day
            const suffix = getDaySuffix(day);
            
            return `${month} ${day}${suffix} at ${hours}:${minutes} UTC`;
        }
        
        // Helper function to get day suffix
        function getDaySuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }
        
        // Function to format content with proper line breaks and styling
        function formatContent(text) {
            if (!text) return '';
            
            // Remove underscores
            text = text.replace(/_/g, '');
            
            // Convert *text* to bold
            text = text.replace(/\*(.*?)\*/g, '<strong>$1</strong>');
            
            // Replace bullet points to be on new lines
            text = text.replace(/([â€¢])/g, '<br>$1');
            
            // Replace numbered lists to be on new lines
            text = text.replace(/(\d+\.)/g, '<br>$1');
            
            // Clean up multiple line breaks
            text = text.replace(/<br><br>/g, '<br>');
            
            // Remove leading line break if it exists
            if (text.startsWith('<br>')) {
                text = text.substring(4);
            }
            
            return text;
        }

        // Function to toggle thread replies
        function toggleThread(button, threadId) {
            const threadDiv = document.getElementById(threadId);
            button.classList.toggle('active');
            threadDiv.classList.toggle('show');
            
            const arrow = button.querySelector('.arrow');
            arrow.textContent = threadDiv.classList.contains('show') ? 'â–¼' : 'â–¶';
        }
        
        // Function to group replies with main messages
        function groupMessages(rows) {
            const mainMessages = [];
            const replies = [];
            
            // Separate main messages and replies
            rows.forEach(row => {
                if (row[7] === 'FALSE' || !row[7]) {
                    // Main message
                    mainMessages.push({
                        id: row[0],
                        authorName: row[1],
                        timestamp: row[2],
                        title: row[3] || '',
                        content: row[4] || '',
                        slackLink: row[5] || '',
                        imageUrl: row[6] || '',
                        replies: []
                    });
                } else {
                    // Reply
                    replies.push({
                        id: row[0],
                        authorName: row[1],
                        timestamp: row[2],
                        content: row[4] || '',
                        imageUrl: row[6] || '',
                        matchingText: row[8] || ''
                    });
                }
            });
            
            // Match replies to main messages
            replies.forEach(reply => {
                // Try to match using matching text column (column I)
                if (reply.matchingText) {
                    for (let message of mainMessages) {
                        if (message.id === reply.matchingText || 
                            message.content.toLowerCase().includes(reply.matchingText.toLowerCase())) {
                            message.replies.push(reply);
                            break;
                        }
                    }
                } else {
                    // Fallback: simple keyword matching
                    const replyWords = reply.content.toLowerCase().split(' ').filter(w => w.length > 4);
                    
                    for (let message of mainMessages) {
                        const messageWords = message.content.toLowerCase().split(' ').filter(w => w.length > 4);
                        const matches = replyWords.filter(word => messageWords.includes(word));
                        
                        if (matches.length >= 2) {
                            message.replies.push(reply);
                            break;
                        }
                    }
                }
            });
            
            return mainMessages;
        }

        // Function to render releases
        function renderReleases(releases) {
            const container = document.getElementById('releases-container');
            
            if (!releases || releases.length === 0) {
                container.innerHTML = '<div class="loading">No releases found</div>';
                return;
            }
            
            container.innerHTML = releases.map(release => {
                const hasReplies = release.replies && release.replies.length > 0;
                const threadId = `thread-${release.id?.replace('.', '-')}`;
                
                return `
                    <div class="release-card">
                        <div class="release-header">
                            <div class="author-info">
                                <span class="author-name">${release.authorName}</span>
                                <span class="timestamp">${formatTimestamp(release.timestamp)}</span>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                ${release.slackLink ? `<a href="${release.slackLink}" target="_blank" class="slack-link">View in Slack â†’</a>` : ''}
                                ${release.imageUrl ? 
                                    `<a href="${release.imageUrl}" target="_blank" class="slack-link" title="View Image">ðŸ“·</a>` 
                                    : ''}
                            </div>
                        </div>
                        
                        ${release.title ? `<div class="release-title">${formatContent(release.title)}</div>` : ''}
                        
                        <div class="release-content">${formatContent(release.content)}</div>
                        
                        ${hasReplies ? `
                            <button class="thread-toggle" onclick="toggleThread(this, '${threadId}')">
                                <span class="arrow">â–¶</span>
                                <span>${release.replies.length} ${release.replies.length === 1 ? 'reply' : 'replies'}</span>
                            </button>
                            
                            <div class="thread-replies" id="${threadId}">
                                ${release.replies.map(reply => `
                                    <div class="reply-message">
                                        <div class="reply-header">
                                            <div class="author-info">
                                                <span class="author-name">${reply.authorName}</span>
                                                <span class="timestamp">${formatTimestamp(reply.timestamp)}</span>
                                            </div>
                                            ${reply.imageUrl ? 
                                                `<a href="${reply.imageUrl}" target="_blank" class="slack-link" title="View Image">ðŸ“·</a>` 
                                                : ''}
                                        </div>
                                        <div class="release-content">${formatContent(reply.content)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Load releases from Google Sheets
        async function loadReleases() {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
                
                const response = await fetch(url);
                const text = await response.text();
                
                // Parse Google's JSON response (it's wrapped in a function call)
                const jsonString = text.substring(47, text.length - 2);
                const data = JSON.parse(jsonString);
                
                // Extract rows (skip header row)
                const rows = data.table.rows.slice(1).map(row => 
                    row.c.map(cell => cell ? cell.v : '')
                );
                
                // Group messages and replies
                const groupedMessages = groupMessages(rows);
                
                // Sort by timestamp (newest first)
                groupedMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                renderReleases(groupedMessages);
            } catch (error) {
                console.error('Error loading releases:', error);
                document.getElementById('releases-container').innerHTML = 
                    '<div class="loading">Error loading releases. Please check back later.</div>';
            }
        }

        // Load releases when page loads
        loadReleases();
        
        // Refresh releases every 2 minutes
        setInterval(loadReleases, 2 * 60 * 1000);
    </script>
</body>
</html>
