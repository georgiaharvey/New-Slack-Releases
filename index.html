<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Release Notes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f8f9fb;
            min-height: 100vh;
            padding: 40px 20px;
            color: #1e1e1e;
        }
        
        .header {
            text-align: center;
            margin-bottom: 50px;
        }
        
        h1 {
            color: #1e1e1e;
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }
        
        .subtitle {
            color: #6b7280;
            font-size: 1.1em;
            font-weight: 400;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .release-card {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
            transition: box-shadow 0.2s ease;
        }
        
        .release-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .release-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .author-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .author-name {
            font-weight: 600;
            color: #1e1e1e;
            font-size: 1.05em;
        }
        
        .timestamp {
            color: #9ca3af;
            font-size: 0.9em;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .slack-link, .image-link {
            text-decoration: none;
            color: #5b6ef8;
            font-size: 0.9em;
            padding: 6px 12px;
            border: 1px solid #5b6ef8;
            border-radius: 6px;
            transition: all 0.2s ease;
            background: white;
            font-weight: 500;
        }
        
        .slack-link:hover, .image-link:hover {
            background: #5b6ef8;
            color: white;
        }
        
        .image-link {
            padding: 6px 10px;
            font-size: 1.1em;
        }
        
        .release-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #1e1e1e;
            margin-bottom: 16px;
            line-height: 1.3;
        }
        
        .release-content {
            color: #4b5563;
            line-height: 1.7;
            font-size: 1em;
        }
        
        .release-content strong {
            color: #1e1e1e;
            font-weight: 600;
        }
        
        .section-header {
            color: #1e1e1e;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 12px;
            font-size: 1.05em;
        }
        
        .bullet-item {
            margin-left: 20px;
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        .thread-toggle {
            background: #f8f9fb;
            border: 1px solid #e5e7eb;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            color: #6b7280;
            font-size: 0.9em;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 16px;
            font-weight: 500;
        }
        
        .thread-toggle:hover {
            background: #f3f4f6;
            color: #4b5563;
        }
        
        .thread-toggle.active {
            background: #5b6ef8;
            color: white;
            border-color: #5b6ef8;
        }
        
        .thread-replies {
            margin-top: 16px;
            padding-left: 20px;
            border-left: 2px solid #e5e7eb;
            display: none;
        }
        
        .thread-replies.show {
            display: block;
        }
        
        .reply-message {
            background: #f8f9fb;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 12px;
        }
        
        .reply-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .loading {
            text-align: center;
            color: #9ca3af;
            font-size: 1.1em;
            padding: 60px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .release-card {
            animation: fadeIn 0.4s ease;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“¦ Release Notes</h1>
        <p class="subtitle">Stay updated with our latest product improvements</p>
    </div>
    
    <div class="container">
        <div id="releases-container">
            <div class="loading">Loading releases...</div>
        </div>
    </div>

    <script>
        // Your Google Sheet configuration
        const SHEET_ID = '1I2ceg13BrlgQGYdVFI2Awxry1_PSoebxqKZEq6dyvIQ';
        const SHEET_NAME = 'October'; // Change this to match your sheet tab name
        
        // Function to format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            
            let date;
            
            // Handle Google Sheets date format: Date(2025,8,24,17,2,28)
            if (typeof timestamp === 'string' && timestamp.startsWith('Date(')) {
                const matches = timestamp.match(/Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/);
                if (matches) {
                    date = new Date(
                        parseInt(matches[1]), 
                        parseInt(matches[2]), 
                        parseInt(matches[3]), 
                        parseInt(matches[4]), 
                        parseInt(matches[5]), 
                        parseInt(matches[6])
                    );
                }
            } else if (timestamp.includes('-') && timestamp.includes(':')) {
                // Format like "2025-10-02 12:50:49"
                date = new Date(timestamp.replace(' ', 'T') + 'Z');
            } else if (timestamp.length > 10) {
                date = new Date(parseFloat(timestamp) * 1000);
            } else {
                date = new Date(timestamp);
            }
            
            if (!date || isNaN(date.getTime())) {
                return '';
            }
            
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            
            const month = months[date.getMonth()];
            const day = date.getDate();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            const suffix = getDaySuffix(day);
            
            return `${month} ${day}${suffix} at ${hours}:${minutes} UTC`;
        }
        
        // Helper function to get day suffix
        function getDaySuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }
        
        // Function to format content with proper line breaks and styling
        function formatContent(text) {
            if (!text) return '';
            
            // Remove underscores
            text = text.replace(/_/g, '');
            
            // Convert *text* to bold
            text = text.replace(/\*(.*?)\*/g, '<strong>$1</strong>');
            
            // Add line breaks after section headers
            const headers = [
                "What's New?", "What's new?", "What's New", 
                "Why it matters", "Why It Matters",
                "Problem", "PROBLEM",
                "What's in this release", "What's In This Release"
            ];
            
            headers.forEach(header => {
                const regex = new RegExp(`(${header.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                text = text.replace(regex, '<div class="section-header">$1</div>');
            });
            
            // Format bullet points - both â€¢ and â—¦
            text = text.replace(/([â€¢â—¦])\s*/g, '<div class="bullet-item">$1 ');
            // Close the div tags for bullets
            text = text.replace(/(<div class="bullet-item">[â€¢â—¦][^<]*)/g, '$1</div>');
            
            // Format numbered lists
            text = text.replace(/(\d+\.)\s*/g, '<div class="bullet-item">$1 ');
            // Close the div tags for numbered items
            text = text.replace(/(<div class="bullet-item">\d+\.[^<]*)/g, '$1</div>');
            
            return text;
        }

        // Function to toggle thread replies
        function toggleThread(button, threadId) {
            const threadDiv = document.getElementById(threadId);
            button.classList.toggle('active');
            threadDiv.classList.toggle('show');
            
            const arrow = button.querySelector('.arrow');
            arrow.textContent = threadDiv.classList.contains('show') ? 'â–¼' : 'â–¶';
        }
        
        // Function to group replies with main messages
        function groupMessages(rows) {
            const mainMessages = [];
            const replies = [];
            
            // Separate main messages and replies
            rows.forEach(row => {
                if (row[7] === 'FALSE' || !row[7]) {
                    // Main message
                    mainMessages.push({
                        id: row[0],
                        authorName: row[1],
                        timestamp: row[2],
                        title: row[3] || '',
                        content: row[4] || '',
                        slackLink: row[5] || '',
                        imageUrl: row[6] || '',
                        replies: []
                    });
                } else {
                    // Reply
                    replies.push({
                        id: row[0],
                        authorName: row[1],
                        timestamp: row[2],
                        content: row[4] || '',
                        imageUrl: row[6] || '',
                        matchingText: row[8] || ''
                    });
                }
            });
            
            // Match replies to main messages
            replies.forEach(reply => {
                if (reply.matchingText) {
                    for (let message of mainMessages) {
                        if (message.id === reply.matchingText || 
                            message.content.toLowerCase().includes(reply.matchingText.toLowerCase())) {
                            message.replies.push(reply);
                            break;
                        }
                    }
                } else {
                    const replyWords = reply.content.toLowerCase().split(' ').filter(w => w.length > 4);
                    
                    for (let message of mainMessages) {
                        const messageWords = message.content.toLowerCase().split(' ').filter(w => w.length > 4);
                        const matches = replyWords.filter(word => messageWords.includes(word));
                        
                        if (matches.length >= 2) {
                            message.replies.push(reply);
                            break;
                        }
                    }
                }
            });
            
            return mainMessages;
        }

        // Function to render releases
        function renderReleases(releases) {
            const container = document.getElementById('releases-container');
            
            if (!releases || releases.length === 0) {
                container.innerHTML = '<div class="loading">No releases found</div>';
                return;
            }
            
            container.innerHTML = releases.map(release => {
                const hasReplies = release.replies && release.replies.length > 0;
                const threadId = `thread-${release.id?.replace('.', '-')}`;
                
                return `
                    <div class="release-card">
                        <div class="release-header">
                            <div class="author-info">
                                <span class="author-name">${release.authorName}</span>
                                <span class="timestamp">${formatTimestamp(release.timestamp)}</span>
                            </div>
                            <div class="action-buttons">
                                ${release.imageUrl ? 
                                    `<a href="${release.imageUrl}" target="_blank" class="image-link" title="View Image">ðŸ“·</a>` 
                                    : ''}
                                ${release.slackLink ? `<a href="${release.slackLink}" target="_blank" class="slack-link">View in Slack â†’</a>` : ''}
                            </div>
                        </div>
                        
                        ${release.title ? `<div class="release-title">${formatContent(release.title)}</div>` : ''}
                        
                        <div class="release-content">${formatContent(release.content)}</div>
                        
                        ${hasReplies ? `
                            <button class="thread-toggle" onclick="toggleThread(this, '${threadId}')">
                                <span class="arrow">â–¶</span>
                                <span>${release.replies.length} ${release.replies.length === 1 ? 'reply' : 'replies'}</span>
                            </button>
                            
                            <div class="thread-replies" id="${threadId}">
                                ${release.replies.map(reply => `
                                    <div class="reply-message">
                                        <div class="reply-header">
                                            <div class="author-info">
                                                <span class="author-name">${reply.authorName}</span>
                                                <span class="timestamp">${formatTimestamp(reply.timestamp)}</span>
                                            </div>
                                            ${reply.imageUrl ? 
                                                `<a href="${reply.imageUrl}" target="_blank" class="image-link" title="View Image">ðŸ“·</a>` 
                                                : ''}
                                        </div>
                                        <div class="release-content">${formatContent(reply.content)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Load releases from Google Sheets
        async function loadReleases() {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
                
                const response = await fetch(url);
                const text = await response.text();
                
                // Parse Google's JSON response (it's wrapped in a function call)
                const jsonString = text.substring(47, text.length - 2);
                const data = JSON.parse(jsonString);
                
                // Extract rows (skip header row)
                const rows = data.table.rows.slice(1).map(row => 
                    row.c.map(cell => cell ? cell.v : '')
                );
                
                // Group messages and replies
                const groupedMessages = groupMessages(rows);
                
                // Sort by timestamp (newest first)
                groupedMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                renderReleases(groupedMessages);
            } catch (error) {
                console.error('Error loading releases:', error);
                document.getElementById('releases-container').innerHTML = 
                    '<div class="loading">Error loading releases. Please check back later.</div>';
            }
        }

        // Load releases when page loads
        loadReleases();
        
        // Refresh releases every 2 minutes
        setInterval(loadReleases, 2 * 60 * 1000);
    </script>
</body>
</html>
